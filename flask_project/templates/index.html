{% extends 'base.html' %}

{% block title %}YatraHub: Select Destination{% endblock %}

{% block head %}
<style>
    .carousel-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }

    .carousel-item {
        height: 100vh;
    }

    .carousel-item img {
        object-fit: cover;
        width: 100%;
        height: 100%;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: -1;
    }

    .destination-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        backdrop-filter: blur(8px);
    }

    .search-container {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    #destination-input {
        padding-left: 2.5rem;
        border: 2px solid #e9ecef;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    #destination-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    }

    #suggestions-box {
        position: absolute;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: 0.5rem;
        display: none;
    }

    .suggestion-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        line-height: 1.4;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .suggestion-item i {
        color: #6c757d;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover {
        background-color: #f8f9fa;
    }

    .suggestion-item strong {
        color: #0d6efd;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Carousel Background -->
<div id="backgroundCarousel" class="carousel slide carousel-fade carousel-background" data-bs-ride="carousel">
    <div class="carousel-inner">
        {% for i in range(1, 15) %}  {# Creates a loop from 1 to 6 #}
            <div class="carousel-item {% if i == 1 %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/destination' ~ i ~ '.jpg') }}" 
                     alt="Travel Destination {{ i }}"
                     onerror="this.src='{{ url_for('static', filename='images/default-destination.jpg') }}'">
            </div>
        {% endfor %}
    </div>
    
    <!-- Carousel Controls -->
    <button class="carousel-control-prev" type="button" data-bs-target="#backgroundCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#backgroundCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>
<div class="overlay"></div>

<div class="destination-container">
    <h1 class="text-center mb-4">
        <i class="fas fa-map-marker-alt me-2"></i>Where are you going?
    </h1>

    <form method="POST" id="destination-form">
        {{ form.hidden_tag() }}
        <div class="mb-4">
            <label for="destination-input" class="form-label">
                <i class="fas fa-search me-2"></i>{{ form.destination.label.text }}
            </label>
            <div class="search-container">
                <i class="fas fa-location-dot search-icon"></i>
                {{ form.destination(class="form-control", id="destination-input", autocomplete="off", 
                   placeholder="Enter a city or place...") }}
                <div id="suggestions-box"></div>
            </div>
            {% if form.destination.errors %}
                <small class="text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.destination.errors[0] }}
                </small>
            {% endif %}
        </div>
        {{ form.latitude }}
        {{ form.longitude }}
        {{ form.display_name }}
        <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-right me-2"></i>Next
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add this before your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the carousel with custom settings
    new bootstrap.Carousel(document.getElementById('backgroundCarousel'), {
        interval: 5000, // Change slides every 5 seconds
        pause: false,   // Don't pause on hover
        wrap: true      // Loop continuously
    });

    const destinationInput = document.getElementById('destination-input');
    const suggestionsBox = document.getElementById('suggestions-box');
    let typingTimer;
    const doneTypingInterval = 300; // Wait for 300ms after user stops typing

    destinationInput.addEventListener('input', function() {
        clearTimeout(typingTimer);
        const searchTerm = this.value;
        
        if (searchTerm.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        typingTimer = setTimeout(() => {
            fetch('/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ 'destination': searchTerm })
            })
            .then(response => response.json())
            .then(data => {
                suggestionsBox.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('suggestion-item');
                        
                        // Highlight the matching part
                        const displayName = suggestion.display_name;
                        const matchIndex = displayName.toLowerCase().indexOf(searchTerm.toLowerCase());
                        if (matchIndex >= 0) {
                            const before = displayName.substring(0, matchIndex);
                            const match = displayName.substring(matchIndex, matchIndex + searchTerm.length);
                            const after = displayName.substring(matchIndex + searchTerm.length);
                            suggestionItem.innerHTML = `
                                <i class="fas fa-map-pin"></i>
                                ${before}<strong>${match}</strong>${after}
                            `;
                        } else {
                            suggestionItem.textContent = displayName;
                        }

                        suggestionItem.addEventListener('click', function() {
                            destinationInput.value = suggestion.display_name;
                            document.getElementById('latitude').value = suggestion.lat;
                            document.getElementById('longitude').value = suggestion.lon;
                            document.getElementById('display_name').value = suggestion.display_name;
                            suggestionsBox.style.display = 'none';
                        });
                        suggestionsBox.appendChild(suggestionItem);
                    });
                    suggestionsBox.style.display = 'block';
                } else {
                    suggestionsBox.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                suggestionsBox.style.display = 'none';
            });
        }, doneTypingInterval);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', function(event) {
        if (!destinationInput.contains(event.target) && !suggestionsBox.contains(event.target)) {
            suggestionsBox.style.display = 'none';
        }
    });
});
</script>
{% endblock %}